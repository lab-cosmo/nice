

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>User guide &mdash; NICE  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Tutorial" href="methane_home_pc_tutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> NICE
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Nice</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../preambule.html">NICE</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="methane_home_pc_tutorial.html">Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">User guide</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Getting-coefficients">Getting coefficients</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Initial-scaler">Initial scaler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Data-structure">Data structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Compressors">Compressors</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Expansioner">Expansioner</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Purifiers:">Purifiers:</a></li>
<li class="toctree-l1"><a class="reference internal" href="#StandardBlock">StandardBlock</a></li>
<li class="toctree-l1"><a class="reference internal" href="#StandardSequence">StandardSequence</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Custom-regressors-into-purifiers">Custom regressors into purifiers</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Sequential-fitting">Sequential fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Non-standard-sequence">Non standard sequence</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Meet-definition-from-the-article">Meet definition from the article</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NICE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>User guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/symlinks/user_guide.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="User-guide">
<h1>User guide<a class="headerlink" href="#User-guide" title="Permalink to this headline">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="ch">#!rm -r build</span>
<span class="c1">#!rm nice/*.so</span>
<span class="c1">#!rm nice/transformers/*.so</span>
<span class="o">!</span>python3 setup.py build_ext --inplace
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
running build_ext
copying build/lib.linux-x86_64-3.6/nice/naive.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/nice_utilities.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/packing.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/radial_basis.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/rascal_coefficients.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/spherical_coefficients.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/spherical_harmonics.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/test_parallel.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/thresholding.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/unrolling_individual_pca.cpython-36m-x86_64-linux-gnu.so -&gt; nice
copying build/lib.linux-x86_64-3.6/nice/unrolling_pca.cpython-36m-x86_64-linux-gnu.so -&gt; nice
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;import sys</span>
<span class="sd">sys.path.insert(0, &#39;nice&#39;)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1">#os.environ[&#39;OMP_NUM_THREADS&#39;] = &#39;24&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ase.io</span> <span class="k">as</span> <span class="nn">ase_io</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">nice</span>
<span class="kn">from</span> <span class="nn">nice.transformers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nice.rascal_coefficients</span> <span class="kn">import</span> <span class="n">get_rascal_coefficients_parallelized</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Getting-coefficients">
<h1>Getting coefficients<a class="headerlink" href="#Getting-coefficients" title="Permalink to this headline">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">process_structures</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">:</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">shift</span><span class="p">]</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">positions</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">shift</span><span class="p">))</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">pbc</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">wrap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">structures</span> <span class="o">=</span> <span class="n">ase_io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;structures_10k.xyz&#39;</span><span class="p">,</span>
                         <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;0:500&#39;</span><span class="p">)</span>

<span class="n">process_structures</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1">#process_structures(structures_val)</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">HYPERS</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;interaction_cutoff&#39;</span><span class="p">:</span> <span class="mf">6.3</span><span class="p">,</span>
<span class="s1">&#39;max_radial&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;max_angular&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Constant&#39;</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_constant&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<span class="s1">&#39;cutoff_smooth_width&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="s1">&#39;radial_basis&#39;</span><span class="p">:</span> <span class="s1">&#39;GTO&#39;</span><span class="p">,</span>
<span class="s1">&#39;global_species&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
<span class="s1">&#39;expansion_by_species_method&#39;</span><span class="p">:</span> <span class="s1">&#39;user defined&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>First of all we need to get spherical expansion coefficients in proper format. For this purpose I prepared simple wrapper for the rascal to get them in parallel:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">coefficients</span> <span class="o">=</span> <span class="n">get_rascal_coefficients_parallelized</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">HYPERS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 5/5 [00:00&lt;00:00, 84.81it/s]
100%|██████████| 2/2 [00:00&lt;00:00, 285.56it/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coefficients</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;dict&#39;&gt;
(2000, 10, 6, 11)
(500, 10, 6, 11)
</pre></div></div>
</div>
<p>Result is the dictionary, where keys are atomic species, 1 - is H atomic number, 6 is C atomic number. Shapes of the coefficients are [env index, radial/specie index, l, m]. In order to use this function ‘expansion_by_species_defined’ must be user defined since output must be uniform. These properties are set automatically in the hypers dictionary</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">HYPERS</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;interaction_cutoff&#39;</span><span class="p">:</span> <span class="mf">6.3</span><span class="p">,</span>
<span class="s1">&#39;max_radial&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;max_angular&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Constant&#39;</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_constant&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<span class="s1">&#39;cutoff_smooth_width&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="s1">&#39;radial_basis&#39;</span><span class="p">:</span> <span class="s1">&#39;GTO&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">get_rascal_coefficients_parallelized</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">HYPERS</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coefficients</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 5/5 [00:00&lt;00:00, 85.53it/s]
100%|██████████| 2/2 [00:00&lt;00:00, 285.91it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;dict&#39;&gt;
(2000, 10, 6, 11)
(500, 10, 6, 11)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<p>If we would try to set this field to the other value it would raise ValueError:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">HYPERS</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;interaction_cutoff&#39;</span><span class="p">:</span> <span class="mf">6.3</span><span class="p">,</span>
<span class="s1">&#39;max_radial&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;max_angular&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Constant&#39;</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_constant&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<span class="s1">&#39;cutoff_smooth_width&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="s1">&#39;expansion_by_species_method&#39;</span><span class="p">:</span> <span class="s1">&#39;environment wise&#39;</span><span class="p">,</span>
<span class="s1">&#39;radial_basis&#39;</span><span class="p">:</span> <span class="s1">&#39;GTO&#39;</span>
<span class="p">}</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">get_rascal_coefficients_parallelized</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">HYPERS</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coefficients</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-9-dc9e1ed95d31&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      9</span> <span class="ansi-blue-fg">&#39;radial_basis&#39;</span><span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">&#39;GTO&#39;</span>
<span class="ansi-green-intense-fg ansi-bold">     10</span> }
<span class="ansi-green-fg">---&gt; 11</span><span class="ansi-red-fg"> </span>coefficients <span class="ansi-blue-fg">=</span> get_rascal_coefficients_parallelized<span class="ansi-blue-fg">(</span>structures<span class="ansi-blue-fg">,</span> HYPERS<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>
<span class="ansi-green-intense-fg ansi-bold">     13</span> print<span class="ansi-blue-fg">(</span>type<span class="ansi-blue-fg">(</span>coefficients<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/nice2/nice/nice/rascal_coefficients.pyx</span> in <span class="ansi-cyan-fg">nice.rascal_coefficients.get_rascal_coefficients_parallelized</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">    114</span>     <span class="ansi-green-fg">if</span> <span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;expansion_by_species_method&#39;</span> <span class="ansi-green-fg">in</span> hypers<span class="ansi-blue-fg">.</span>keys<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    115</span>         <span class="ansi-green-fg">if</span> <span class="ansi-blue-fg">(</span>hypers<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;expansion_by_species_method&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">!=</span> <span class="ansi-blue-fg">&#39;user defined&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 116</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">raise</span> ValueError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;for proper packing spherical expansion coefficients into [env index, radial/specie index, l, m] shape output should be uniform, thus &#39;expansion_by_species_method&#39; must be &#39;user defined&#39;&#34;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    117</span>
<span class="ansi-green-intense-fg ansi-bold">    118</span>     hypers<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;expansion_by_species_method&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&#39;user defined&#39;</span>

<span class="ansi-red-fg">ValueError</span>: for proper packing spherical expansion coefficients into [env index, radial/specie index, l, m] shape output should be uniform, thus &#39;expansion_by_species_method&#39; must be &#39;user defined&#39;
</pre></div></div>
</div>
<p>and if given global species are insufficient it would add all missing species:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">HYPERS</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;interaction_cutoff&#39;</span><span class="p">:</span> <span class="mf">6.3</span><span class="p">,</span>
<span class="s1">&#39;max_radial&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;max_angular&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Constant&#39;</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_constant&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<span class="s1">&#39;cutoff_smooth_width&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="s1">&#39;radial_basis&#39;</span><span class="p">:</span> <span class="s1">&#39;GTO&#39;</span><span class="p">,</span>
<span class="s1">&#39;global_species&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">42</span><span class="p">],</span>
<span class="s1">&#39;expansion_by_species_method&#39;</span><span class="p">:</span> <span class="s1">&#39;user defined&#39;</span>
<span class="p">}</span>

<span class="n">coefficients</span> <span class="o">=</span> <span class="n">get_rascal_coefficients_parallelized</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">HYPERS</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">coefficients</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/psi4conda/lib/python3.6/site-packages/ipykernel_launcher.py:13: UserWarning: atom with type 6 is presented in the dataset but it is not listed in the global_species, adding it
  del sys.path[0]
100%|██████████| 5/5 [00:00&lt;00:00, 62.41it/s]
100%|██████████| 4/4 [00:00&lt;00:00, 378.49it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;dict&#39;&gt;
(2000, 20, 6, 11)
(500, 20, 6, 11)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<p>Note increase in dimension for the radial/specie index because of additional 117 and 42 atomic types</p>
<p>Let’s calculate once again coefficients without global species for future manipulation</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">HYPERS</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;interaction_cutoff&#39;</span><span class="p">:</span> <span class="mf">6.3</span><span class="p">,</span>
<span class="s1">&#39;max_radial&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;max_angular&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Constant&#39;</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_constant&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<span class="s1">&#39;cutoff_smooth_width&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="s1">&#39;radial_basis&#39;</span><span class="p">:</span> <span class="s1">&#39;GTO&#39;</span>
<span class="p">}</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">get_rascal_coefficients_parallelized</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">HYPERS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 5/5 [00:00&lt;00:00, 50.48it/s]
100%|██████████| 2/2 [00:00&lt;00:00, 264.14it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(2000, 10, 6, 11)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="section" id="Initial-scaler">
<h2>Initial scaler<a class="headerlink" href="#Initial-scaler" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_variances</span><span class="p">(</span><span class="n">coefficients</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">total_values</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coefficients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">coefficients</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">:(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">total_values</span> <span class="o">+=</span> <span class="n">coefficients</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">total_values</span><span class="p">)</span>


<span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;variance&#39;</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])))</span>

<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">scaled</span><span class="p">)))</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;variance&#39;</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mf">234241.1234</span><span class="p">)</span>
<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mf">234241.1234</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">scaled</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
5.733729249698362e-06
(500,)
[6.49364730e-11 7.50399423e-11 1.06083041e-10 7.92201745e-11
 8.45345449e-11 4.80953590e-11 7.44135183e-11 1.06036195e-10
 7.10430419e-11 1.90032742e-10]
(500,)
7.62677172180371e-11
(500, 10, 6, 11)
0.6565484911820938
(500,)
[0.85142804 0.98390177 1.3909298  1.03871176 1.10839223 0.63061228
 0.97568829 1.39031557 0.93149559 2.49165373]
(500,)
1.0
(500, 10, 6, 11)
0.6565484911820939
(500,)
[0.85142804 0.98390177 1.3909298  1.03871176 1.10839223 0.63061228
 0.97568829 1.39031557 0.93149559 2.49165373]
(500,)
1.0000000000000002
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;variance&#39;</span><span class="p">,</span> <span class="n">individually</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])))</span>

<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">scaled</span><span class="p">)))</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;variance&#39;</span><span class="p">,</span> <span class="n">individually</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mf">234241.1234</span><span class="p">)</span>
<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mf">234241.1234</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_variances</span><span class="p">(</span><span class="n">scaled</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
5.733729249698362e-06
(500,)
[6.49364730e-11 7.50399423e-11 1.06083041e-10 7.92201745e-11
 8.45345449e-11 4.80953590e-11 7.44135183e-11 1.06036195e-10
 7.10430419e-11 1.90032742e-10]
(500,)
7.62677172180371e-11
(500, 10, 6, 11)
0.7115293730849263
(500,)
[1. 1. 1. 1. 1. 1. 1. 1. 1. 1.]
(500,)
1.0
(500, 10, 6, 11)
0.7115293730849261
(500,)
[1. 1. 1. 1. 1. 1. 1. 1. 1. 1.]
(500,)
1.0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_signal_integral</span><span class="p">(</span><span class="n">coefficients</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;signal integral&#39;</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])))</span>

<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">scaled</span><span class="p">)))</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;signal integral&#39;</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mf">234241.1234</span><span class="p">)</span>
<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mf">234241.1234</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">scaled</span><span class="p">)))</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
5.733729249698362e-06
[8.49337156e-09 9.63014019e-09 1.00053500e-08 8.52617777e-09
 8.92388552e-09 8.31677419e-09 8.15025958e-09 9.19741150e-09
 8.55213704e-09 9.22233372e-09]
8.509823773178662e-09
(500, 10, 6, 11)
0.06215511841230651
[0.99806668 1.13164978 1.17574116 1.00192178 1.04865691 0.9773145
 0.95774716 1.08079929 1.00497228 1.08372793]
0.9999999999999996
(500, 10, 6, 11)
0.06215511841230652
[0.99806668 1.13164978 1.17574116 1.00192178 1.04865691 0.9773145
 0.95774716 1.08079929 1.00497228 1.08372793]
1.0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;signal integral&#39;</span><span class="p">,</span> <span class="n">individually</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])))</span>

<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">scaled</span><span class="p">)))</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;signal integral&#39;</span><span class="p">,</span> <span class="n">individually</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mf">234241.1234</span><span class="p">)</span>
<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="mf">234241.1234</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">scaled</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_signal_integral</span><span class="p">(</span><span class="n">scaled</span><span class="p">)))</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
5.733729249698362e-06
[8.49337156e-09 9.63014019e-09 1.00053500e-08 8.52617777e-09
 8.92388552e-09 8.31677419e-09 8.15025958e-09 9.19741150e-09
 8.55213704e-09 9.22233372e-09]
8.509823773178662e-09
(500, 10, 6, 11)
0.06221528852749003
[1. 1. 1. 1. 1. 1. 1. 1. 1. 1.]
1.0
(500, 10, 6, 11)
0.06221528852749003
[1. 1. 1. 1. 1. 1. 1. 1. 1. 1.]
1.0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">InitialScaler</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;asdfas&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-16-e727c86b3834&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>scaler <span class="ansi-blue-fg">=</span> InitialScaler<span class="ansi-blue-fg">(</span>mode <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&#39;asdfas&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/nice2/nice/nice/transformers/miscellaneous.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, mode, individually)</span>
<span class="ansi-green-intense-fg ansi-bold">    104</span>         self<span class="ansi-blue-fg">.</span>mode_ <span class="ansi-blue-fg">=</span> mode
<span class="ansi-green-intense-fg ansi-bold">    105</span>         <span class="ansi-green-fg">if</span> <span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>mode_ <span class="ansi-blue-fg">!=</span> <span class="ansi-blue-fg">&#34;signal integral&#34;</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">and</span> <span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>mode_ <span class="ansi-blue-fg">!=</span> <span class="ansi-blue-fg">&#34;variance&#34;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 106</span><span class="ansi-red-fg">             raise ValueError(&#34;mode should be ethier &#34;
</span><span class="ansi-green-intense-fg ansi-bold">    107</span>                              &#34;\&#34;signal integral\&#34; ethier \&#34;variance\&#34;.&#34;)
<span class="ansi-green-intense-fg ansi-bold">    108</span>

<span class="ansi-red-fg">ValueError</span>: mode should be ethier &#34;signal integral&#34; ethier &#34;variance&#34;.
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Data-structure">
<h1>Data structure<a class="headerlink" href="#Data-structure" title="Permalink to this headline">¶</a></h1>
<p>In the implementation I keep the covariants which do not change under the inversion and the covariants which change sign separatelly. The first I call even the second I call odd. So, the first thing to do is to split coefficients into these two groups:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_even_1</span><span class="p">,</span> <span class="n">data_odd_1</span>  <span class="o">=</span> <span class="n">InitialTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>I have a class to store the data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">data_even_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;nice.nice_utilities.Data object at 0x2abe935d4780&gt;
</pre></div></div>
</div>
<p>fields are covariants_, actual_sizes_, importances_</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">data_even_1</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_1</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_1</span><span class="o">.</span><span class="n">importances_</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data_odd_1</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_odd_1</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_odd_1</span><span class="o">.</span><span class="n">importances_</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 10, 6, 11)
[10, 0, 10, 0, 10, 0]
None

(500, 10, 6, 11)
[0, 10, 0, 10, 0, 10]
None

</pre></div></div>
</div>
<p>This class supports slicing in the environment index:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_even_small</span> <span class="o">=</span> <span class="n">data_even_1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_small</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_small</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_small</span><span class="o">.</span><span class="n">importances_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(20, 10, 6, 11)
[10, 0, 10, 0, 10, 0]
None
</pre></div></div>
</div>
<p>Also this class has a method to get invariants:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">invariants</span> <span class="o">=</span> <span class="n">data_even_1</span><span class="o">.</span><span class="n">get_invariants</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">invariants</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">invariants</span> <span class="o">=</span> <span class="n">data_odd_1</span><span class="o">.</span><span class="n">get_invariants</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">invariants</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 10)
(500, 0)
</pre></div></div>
</div>
<p>I think that the names tell for themselves. Importances are the arrays which would tell how important this particular covariant is and this field would be not None after the pca transformation.</p>
</div>
<div class="section" id="Compressors">
<h1>Compressors<a class="headerlink" href="#Compressors" title="Permalink to this headline">¶</a></h1>
<p>Let’s do it:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_even_1</span><span class="p">,</span> <span class="n">data_odd_1</span><span class="p">)</span>
<span class="n">tmp_even</span><span class="p">,</span> <span class="n">tmp_odd</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_1</span><span class="p">,</span> <span class="n">data_odd_1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 9, 6, 11)
[9 0 9 0 9 0]
</pre></div></div>
</div>
<p>This class will do individual pca over different lambda channels. Both means for both even and odd data. One common thing about all compressors (pca) and purifiers is the behaviour of n_components parameter. If it is not specified (None) than the pca still will be done with the number of components equal to the number of covariants for each individual lambda:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data_even_1</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data_odd_1</span><span class="p">)</span>
<span class="n">artificial_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">artificial_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
<span class="nb">print</span><span class="p">(</span><span class="n">artificial_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[3, 0, 6, 0, 10, 0]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">()</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="n">tmp_even</span><span class="p">,</span> <span class="n">tmp_odd</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 10, 6, 11)
[ 3  0  6  0 10  0]
(500, 10, 6, 11)
[ 0 10  0 10  0 10]
</pre></div></div>
</div>
<p>Also, if it is specified, but the number of components for given lambda channel is less than that number it would keep this number of components:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="n">tmp_even</span><span class="p">,</span> <span class="n">tmp_odd</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 7, 6, 11)
[3 0 6 0 7 0]
(500, 7, 6, 11)
[0 7 0 7 0 7]
</pre></div></div>
</div>
<p>Another parameter, which also behaves the same way for all compressors and purifiers is num_to_fit. It can be either number either string, like ‘10x’. The first would mean that pca would use the specified number of data points to fit, even if the total amount of provided data is higher. But data point I mean single double. I. e. for given the number of data points would be (lambda + 1) * number_of_environments. If num_to_fit is the string than the the number of data points to fit would be
determined as current number of components multiplier by number in string. Default value is ‘10x’. It will warn you if the amount of provided data is smaller than one given by num_to_fit and will raise ValueError if 1) num_to_fit is specified to be so small that it is not possible to fit pca or 2) if amount of provided data is too small to fit pca</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">num_to_fit</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="n">tmp_even</span><span class="p">,</span> <span class="n">tmp_odd</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 7, 6, 11)
[3 0 6 0 7 0]
(500, 7, 6, 11)
[0 7 0 7 0 7]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 2000, while number of vectors is 500, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 500. Number of pca components is 7.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 2000, while number of vectors is 500, dimensionality of single vector (lambd + 1) is 3, i. e. total number of points is 1500. Number of pca components is 7.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 2000, while number of vectors is 500, dimensionality of single vector (lambd + 1) is 2, i. e. total number of points is 1000. Number of pca components is 7.
  RuntimeWarning,
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">num_to_fit</span> <span class="o">=</span> <span class="s1">&#39;100x&#39;</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="n">tmp_even</span><span class="p">,</span> <span class="n">tmp_odd</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 7, 6, 11)
[3 0 6 0 7 0]
(500, 7, 6, 11)
[0 7 0 7 0 7]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 700, while number of vectors is 500, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 500. Number of pca components is 7.
  RuntimeWarning,
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">num_to_fit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="n">tmp_even</span><span class="p">,</span> <span class="n">tmp_odd</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-26-9ecb6c9b4bee&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> pca <span class="ansi-blue-fg">=</span> IndividualLambdaPCAsBoth<span class="ansi-blue-fg">(</span>n_components <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">7</span><span class="ansi-blue-fg">,</span> num_to_fit <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span>pca<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>artificial_even<span class="ansi-blue-fg">,</span> artificial_odd<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> tmp_even<span class="ansi-blue-fg">,</span> tmp_odd <span class="ansi-blue-fg">=</span> pca<span class="ansi-blue-fg">.</span>transform<span class="ansi-blue-fg">(</span>artificial_even<span class="ansi-blue-fg">,</span> artificial_odd<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span> print<span class="ansi-blue-fg">(</span>tmp_even<span class="ansi-blue-fg">.</span>covariants_<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span> print<span class="ansi-blue-fg">(</span>tmp_even<span class="ansi-blue-fg">.</span>actual_sizes_<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/nice/nice/transformers/compressors.py</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(self, data_even, data_odd)</span>
<span class="ansi-green-intense-fg ansi-bold">    158</span>     <span class="ansi-green-fg">def</span> fit<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> data_even<span class="ansi-blue-fg">,</span> data_odd<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    159</span>
<span class="ansi-green-fg">--&gt; 160</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>even_pca_<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>data_even<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    161</span>         self<span class="ansi-blue-fg">.</span>odd_pca_<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>data_odd<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    162</span>         self<span class="ansi-blue-fg">.</span>fitted_ <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span>

<span class="ansi-green-fg">~/nice/nice/transformers/compressors.py</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(self, data)</span>
<span class="ansi-green-intense-fg ansi-bold">     88</span>                             (&#34;specified parameter num fit ({}) is too &#34;
<span class="ansi-green-intense-fg ansi-bold">     89</span>                              <span class="ansi-blue-fg">&#34;small to fit pca with number of components {}.&#34;</span>
<span class="ansi-green-fg">---&gt; 90</span><span class="ansi-red-fg">                              ).format(num_fit_now, n_components_now))
</span><span class="ansi-green-intense-fg ansi-bold">     91</span>
<span class="ansi-green-intense-fg ansi-bold">     92</span>                 <span class="ansi-green-fg">if</span> data<span class="ansi-blue-fg">.</span>covariants_<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">*</span> <span class="ansi-blue-fg">(</span>lambd <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">&lt;</span> num_fit_now<span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">ValueError</span>: specified parameter num fit (1) is too small to fit pca with number of components 7.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">artificial_odd</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">tmp_even</span><span class="p">,</span> <span class="n">tmp_odd</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">artificial_even</span><span class="p">,</span> <span class="n">artificial_odd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tmp_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-27-7667f755d120&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> pca <span class="ansi-blue-fg">=</span> IndividualLambdaPCAsBoth<span class="ansi-blue-fg">(</span>n_components <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">7</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span>pca<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>artificial_even<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> artificial_odd<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> tmp_even<span class="ansi-blue-fg">,</span> tmp_odd <span class="ansi-blue-fg">=</span> pca<span class="ansi-blue-fg">.</span>transform<span class="ansi-blue-fg">(</span>artificial_even<span class="ansi-blue-fg">,</span> artificial_odd<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span> print<span class="ansi-blue-fg">(</span>tmp_even<span class="ansi-blue-fg">.</span>covariants_<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span> print<span class="ansi-blue-fg">(</span>tmp_even<span class="ansi-blue-fg">.</span>actual_sizes_<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/nice/nice/transformers/compressors.py</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(self, data_even, data_odd)</span>
<span class="ansi-green-intense-fg ansi-bold">    158</span>     <span class="ansi-green-fg">def</span> fit<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> data_even<span class="ansi-blue-fg">,</span> data_odd<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    159</span>
<span class="ansi-green-fg">--&gt; 160</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>even_pca_<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>data_even<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    161</span>         self<span class="ansi-blue-fg">.</span>odd_pca_<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span>data_odd<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    162</span>         self<span class="ansi-blue-fg">.</span>fitted_ <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span>

<span class="ansi-green-fg">~/nice/nice/transformers/compressors.py</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(self, data)</span>
<span class="ansi-green-intense-fg ansi-bold">     75</span>                             lambd <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     76</span>                             data<span class="ansi-blue-fg">.</span>covariants_<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">*</span> <span class="ansi-blue-fg">(</span>lambd <span class="ansi-blue-fg">+</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">---&gt; 77</span><span class="ansi-red-fg">                             </span>n_components_now<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     78</span>                         ))
<span class="ansi-green-intense-fg ansi-bold">     79</span>

<span class="ansi-red-fg">ValueError</span>: not enough data to fit pca, number of vectors is 2, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 2, while number of components is 7.
</pre></div></div>
</div>
<p>PCA also estimates feature importances:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_even_1</span><span class="p">,</span> <span class="n">data_odd_1</span><span class="p">)</span>
<span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_1</span><span class="p">,</span> <span class="n">data_odd_1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="o">.</span><span class="n">importances_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(9, 6)
</pre></div></div>
</div>
<p>Array is two dimensional, first dimension corresponds to feature index and the second to lambda. Valid elements are [:actual_sizes_[lambd], lambd]</p>
<p>Instance of this class has fields pca.even_pca_.pcas_[:] and pca.odd_pca.pcas_[:] which are instances of class which inherits from sklearn.decomposition.TruncatedSVD. Thus they have explained_variance_, explained_variance_ratio_ and singular_values_. In addition they have importances_ which are subsequently used by ThresholdExpansioner. Importances_ are almost the same as explained_variance_ratio_ with the only difference that they are normalized not to the total variance before
pca transformation but to the total variance after. I. e. sum(importance_) is always 1.0</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">proper_log_plot</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">even_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]):</span> <span class="c1">#it can be None if input data doens&#39;t have any features for this lambda</span>
        <span class="n">proper_log_plot</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">even_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]</span><span class="o">.</span><span class="n">singular_values_</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lambd</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_55_0.png" src="../_images/symlinks_user_guide_55_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">odd_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]):</span> <span class="c1">#it can be None if input data doens&#39;t have any features for this lambda</span>
        <span class="n">proper_log_plot</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">odd_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]</span><span class="o">.</span><span class="n">singular_values_</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lambd</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_56_0.png" src="../_images/symlinks_user_guide_56_0.png" />
</div>
</div>
<p>There is one another compressor - InvariantsPCA. The only difference is that inputs and outputs are invariants. Now not both, only single parity.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">InvariantsPCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num_to_fit</span> <span class="o">=</span> <span class="s1">&#39;300x&#39;</span><span class="p">)</span>
<span class="n">invariants_even</span> <span class="o">=</span> <span class="n">data_even_1</span><span class="o">.</span><span class="n">get_invariants</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">invariants_even</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">invariants_even</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">invariants_even</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 10)
(500, 5)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/compressors.py:201: UserWarning: Amount of provided data is less than the desired one to fit PCA. Number of components is 5, desired number of environments is 1500, actual number of environments is 500.
  self.n_components, num_fit_now, X.shape[0]))
</pre></div></div>
</div>
<p>This inherits from sklearn.decomposition.PCA, thus it also has importance fields:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[6.56740086e-01 3.32300866e-01 7.66021533e-03 3.29425638e-03
 4.57583355e-06]
0.9999999995966687
</pre></div></div>
</div>
<p>To deal with covariants and single parity there is class <strong>IndividualLambdaPCAs</strong></p>
</div>
<div class="section" id="Expansioner">
<h1>Expansioner<a class="headerlink" href="#Expansioner" title="Permalink to this headline">¶</a></h1>
<p>For thresholding expansion there is a class ThresholdExpansioner:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">expansioner</span> <span class="o">=</span> <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="n">num_expand</span> <span class="o">=</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">expansioner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">)</span>
<span class="n">data_even_2</span><span class="p">,</span> <span class="n">data_odd_2</span> <span class="o">=</span> <span class="n">expansioner</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_2</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_2</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_odd_2</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 34, 6, 11)
[16 15 33 26 34 23]
[ 0 24 20 34 26 30]
</pre></div></div>
</div>
<p>it operates with two even-odd pairs of covariants and produces clebsch-gordan product of them. I. e. if the body orders of the inputs are nu1 and nu2 output would be of body order nu1 + nu2.</p>
<p>As the main parameter it accepts num_expand and by binary search looks for such threshold to make number of pairs {&lt;… l1 *&gt; &lt;… l2 *} be equal to num_expand. After that each such pair generates at most one feature to each lambda channel. (It depends on the values of l1 and l2 by triangle inequality) Thus the size of the output for different lambda channels is different.</p>
<p>If num_expand is not specified it would do full expansion:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">expansioner</span> <span class="o">=</span> <span class="n">ThresholdExpansioner</span><span class="p">()</span>
<span class="n">expansioner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">)</span>
<span class="n">data_even_2</span><span class="p">,</span> <span class="n">data_odd_2</span> <span class="o">=</span> <span class="n">expansioner</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_2</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_2</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_odd_2</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 1134, 6, 11)
[ 486  405 1053  810 1134  729]
[   0  810  648 1134  810  972]
</pre></div></div>
</div>
<p>Let’s take invariants. 486 corresponds to 9 * 9 * (5 + 1). I. e. powerspectrum without it’s symmetry with respect to changing the order of n1 and n2</p>
<p>Majority of the time in the fitting process takes calculation of clebsch-gordan coefficients. Thus, if we are planning to fit several expansioners it is good idea to calculate clebsch-gordan coefficients once:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">clebsch</span> <span class="o">=</span> <span class="n">ClebschGordan</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">expansioner</span> <span class="o">=</span> <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="n">num_expand</span> <span class="o">=</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">expansioner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">clebsch_gordan</span> <span class="o">=</span> <span class="n">clebsch</span><span class="p">)</span>
<span class="n">data_even_2</span><span class="p">,</span> <span class="n">data_odd_2</span> <span class="o">=</span> <span class="n">expansioner</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_2</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_2</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_odd_2</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 34, 6, 11)
[16 15 33 26 34 23]
[ 0 24 20 34 26 30]
</pre></div></div>
</div>
<p>At the last step it is not necessary to calcualte all covariants, it is enough to calculate only invariants. In order to achieve this one can pass mode = ‘invariants’:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">expansioner</span> <span class="o">=</span> <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="n">num_expand</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">)</span>
<span class="n">expansioner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">clebsch_gordan</span> <span class="o">=</span> <span class="n">clebsch</span><span class="p">)</span>
<span class="n">invariants_even</span><span class="p">,</span> <span class="n">invariants_odd</span> <span class="o">=</span> <span class="n">expansioner</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">,</span> <span class="n">data_even_1_t</span><span class="p">,</span> <span class="n">data_odd_1_t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">invariants_even</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">invariants_odd</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 41)
(500, 0)
</pre></div></div>
</div>
<p>It is usefull not only at the last step, because we most probably would want to calculate huge number of invariants at each step, which is computationally feasible, while calculation of the same amount of covariants is not.</p>
</div>
<div class="section" id="Purifiers:">
<h1>Purifiers:<a class="headerlink" href="#Purifiers:" title="Permalink to this headline">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">old_invariants</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">new_invariants</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">pur</span> <span class="o">=</span> <span class="n">InvariantsPurifier</span><span class="p">()</span>
<span class="n">pur</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">old_invariants</span><span class="p">,</span> <span class="n">new_invariants</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_invariants</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">new_invariants</span> <span class="o">*</span> <span class="n">new_invariants</span><span class="p">))</span>
<span class="n">new_invariants_p</span> <span class="o">=</span> <span class="n">pur</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">old_invariants</span><span class="p">,</span> <span class="n">new_invariants</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_invariants_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">new_invariants_p</span> <span class="o">*</span> <span class="n">new_invariants_p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 30)
0.3347158597308048
(500, 30)
0.05837207039286959
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/purifiers.py:55: UserWarning: Amount of provided data is less than the desired one to fit InvariantsPurifer. Number of old features is 150, desired number of environments is 1500, actual number of environments is 500.
  total_num, num_fit_now, new_block.shape[0]))
</pre></div></div>
</div>
<p>parameters are num_to_fit, max_take and regressor. Behaviour of num_to_fit is the same as in case of compressors. Max_take determines amount of invariant to take from old ones. If it is None, that all previous invariants would be used for purification. If it is int than from each block no more than max_take invariants would be used. In this case invariants would be picked from the begining, assuming that previously you did something like pca transformation and invariants are sorted in the
order to decaying importance. If you use this option it is your responsibility to assure this. If max_take is np.array of list than it is considered as the set of individual numbers to take from each block.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">old_invariants</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">new_invariants</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">pur</span> <span class="o">=</span> <span class="n">InvariantsPurifier</span><span class="p">(</span><span class="n">max_take</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">pur</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">old_invariants</span><span class="p">,</span> <span class="n">new_invariants</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_invariants</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">new_invariants</span> <span class="o">*</span> <span class="n">new_invariants</span><span class="p">))</span>
<span class="n">new_invariants_p</span> <span class="o">=</span> <span class="n">pur</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">old_invariants</span><span class="p">,</span> <span class="n">new_invariants</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_invariants_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">new_invariants_p</span> <span class="o">*</span> <span class="n">new_invariants_p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 30)
0.3347158597308048
(500, 30)
0.07542076163976533
</pre></div></div>
</div>
<p>regressor is the base linear regression class. Potentially with the parameters inside. Default is Ridge(alpha = 1e-12)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">old_invariants</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">new_invariants</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">pur</span> <span class="o">=</span> <span class="n">InvariantsPurifier</span><span class="p">(</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">))</span>
<span class="n">pur</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">old_invariants</span><span class="p">,</span> <span class="n">new_invariants</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_invariants</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">new_invariants</span> <span class="o">*</span> <span class="n">new_invariants</span><span class="p">))</span>
<span class="n">new_invariants_p</span> <span class="o">=</span> <span class="n">pur</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">old_invariants</span><span class="p">,</span> <span class="n">new_invariants</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_invariants_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">new_invariants_p</span> <span class="o">*</span> <span class="n">new_invariants_p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 30)
0.3347158597308048
(500, 30)
0.0834976296945275
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/purifiers.py:55: UserWarning: Amount of provided data is less than the desired one to fit InvariantsPurifer. Number of old features is 150, desired number of environments is 1500, actual number of environments is 500.
  total_num, num_fit_now, new_block.shape[0]))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Lars</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">old_invariants</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">new_invariants</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">pur</span> <span class="o">=</span> <span class="n">InvariantsPurifier</span><span class="p">(</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">Lars</span><span class="p">())</span>
<span class="n">pur</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">old_invariants</span><span class="p">,</span> <span class="n">new_invariants</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_invariants</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">new_invariants</span> <span class="o">*</span> <span class="n">new_invariants</span><span class="p">))</span>
<span class="n">new_invariants_p</span> <span class="o">=</span> <span class="n">pur</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">old_invariants</span><span class="p">,</span> <span class="n">new_invariants</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_invariants_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">new_invariants_p</span> <span class="o">*</span> <span class="n">new_invariants_p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/purifiers.py:55: UserWarning: Amount of provided data is less than the desired one to fit InvariantsPurifer. Number of old features is 150, desired number of environments is 1500, actual number of environments is 500.
  total_num, num_fit_now, new_block.shape[0]))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(500, 30)
0.3347158597308048
(500, 30)
0.058472840670569515
</pre></div></div>
</div>
<p>Unfortunatelly BayesianRidge does not support multitarget regression.</p>
<p><strong>CovariantsPurifierBoth</strong> and <strong>CovariantsPurifier</strong> are the purifiers for covariants. Parameters are the same. In this case there is a subtle moment - you must not fit interecept, otherwise you would get non covariant transformtion since the vector of constants is not covariant. If you use custom regressor it is your responsibility to assure this. If you use regressor from sklearn you can set fit_intercept = False.</p>
<p>Using this blocks it is straightforward to do Nice, but I have couple of classes for convenience.</p>
</div>
<div class="section" id="StandardBlock">
<h1>StandardBlock<a class="headerlink" href="#StandardBlock" title="Permalink to this headline">¶</a></h1>
<p>The typical unit of the nice is the set of 6 blocks. 1) first of all we need to do expansion of covariants. 2) we need to purify them. 3) we need to pca them. Potentially we want to do the same 4-6) with only invariants with much higher num_expand. The class StandardBlock corresponds to this transformation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;def __init__(self, covariants_expansioner = None, covariants_purifier = None,</span>
<span class="sd">              covariants_pca = None, invariants_expansioner = None,</span>
<span class="sd">              invariants_purifier = None, invariants_pca = None,</span>
<span class="sd">              guaranteed_parts_fitted_consistently = False)&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;def __init__(self, covariants_expansioner = None, covariants_purifier = None,\n              covariants_pca = None, invariants_expansioner = None,\n              invariants_purifier = None, invariants_pca = None, \n              guaranteed_parts_fitted_consistently = False)&#39;
</pre></div></div>
</div>
<p>It can be used for any partial task, i. e. if we would like to do small covariants expansion with subsequent purification and big invariants expansion without purification and with subsequent pca:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">block</span> <span class="o">=</span> <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="n">num_expand</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span> <span class="n">CovariantsPurifierBoth</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="n">num_expand</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">InvariantsPCA</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>

</pre></div>
</div>
</div>
<p>If expansioner is not set, than subsequent purification and pca has no sense, and thus it would raise and error:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">block</span> <span class="o">=</span> <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="n">num_expand</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span> <span class="n">CovariantsPurifierBoth</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">InvariantsPCA</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-45-0a178d9df7cc&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> block = StandardBlock(ThresholdExpansioner(num_expand = 10), CovariantsPurifierBoth(), None,
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg">                       None, None, InvariantsPCA(1000))
</span>
<span class="ansi-green-fg">~/nice/nice/transformers/grouping.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, covariants_expansioner, covariants_purifier, covariants_pca, invariants_expansioner, invariants_purifier, invariants_pca, guaranteed_parts_fitted_consistently)</span>
<span class="ansi-green-intense-fg ansi-bold">     54</span>         if (self.invariants_pca_
<span class="ansi-green-intense-fg ansi-bold">     55</span>                 is not None) and (self.invariants_expansioner_ is None):
<span class="ansi-green-fg">---&gt; 56</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">raise</span> ValueError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;can not do pca over not existing invariants&#34;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     57</span>
<span class="ansi-green-intense-fg ansi-bold">     58</span>         if (self.covariants_expansioner_ is not None) and (self.covariants_pca_

<span class="ansi-red-fg">ValueError</span>: can not do pca over not existing invariants
</pre></div></div>
</div>
<p>but we can do only covariants, or only invariants:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">block</span> <span class="o">=</span> <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="n">num_expand</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span> <span class="n">CovariantsPurifierBoth</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;def fit(self, first_even, first_odd, second_even, second_odd,</span>
<span class="sd">            old_even_covariants = None, old_odd_covariants = None,</span>
<span class="sd">            old_even_invariants = None, clebsch_gordan = None):&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;def fit(self, first_even, first_odd, second_even, second_odd, \n            old_even_covariants = None, old_odd_covariants = None,\n            old_even_invariants = None, clebsch_gordan = None):&#39;
</pre></div></div>
</div>
<p>Fit method accepts two even-odd pairs and old covariants and invariants to fit purifiers. It purifiers present in init and no old data is given to fit it would rase Error.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39; def transform(self, first_even, first_odd, second_even, second_odd, old_even_covariants = None, old_odd_covariants = None,</span>
<span class="sd">            old_even_invariants = None):&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39; def transform(self, first_even, first_odd, second_even, second_odd, old_even_covariants = None, old_odd_covariants = None,\n            old_even_invariants = None):&#39;
</pre></div></div>
</div>
<p>Transform method has the same input and it always returns covariants_even, covariants_odd, invariants_even. If covariants branch is absent it would return None, None, invariants_even. If invariants branch is absent it would return covariants_even, covariants_odd, None. (yep, invariants can be taken as covariants[:, :, 0, 0], and this is behavior of StandardSequence).</p>
<p>About guaranteed_parts_fitted_consistently = False later</p>
</div>
<div class="section" id="StandardSequence">
<h1>StandardSequence<a class="headerlink" href="#StandardSequence" title="Permalink to this headline">¶</a></h1>
<p>The vanilla nice is the sequence of standard blocks, where each increase the body order by one. For this purpose I have class StandardSequence:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39; def __init__(self, blocks,</span>
<span class="sd">initial_pca = None,</span>
<span class="sd">guaranteed_parts_fitted_consistently = False):&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39; def __init__(self, blocks, \ninitial_pca = None,\nguaranteed_parts_fitted_consistently = False):&#39;
</pre></div></div>
</div>
<p>It accepts list with blocks, and initial_pca. InitialPCA is needed because input of each block should contain feature importances since the first action is to do expansion. By default (None) it is IndividualLambdaPCAsBoth(), i. e. it doesn’t do any reduction</p>
<p>Example of the usage:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">Lars</span><span class="p">,</span> <span class="n">LassoLars</span>

<span class="n">transformer</span> <span class="o">=</span> <span class="n">StandardSequence</span><span class="p">([</span><span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">),</span>
                                <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                             <span class="n">CovariantsPurifierBoth</span><span class="p">(</span><span class="n">max_take</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">75</span><span class="p">),</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">InvariantsPCA</span><span class="p">(</span><span class="mi">200</span><span class="p">)),</span>
                                <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                             <span class="n">CovariantsPurifierBoth</span><span class="p">(</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1e5</span><span class="p">,</span> <span class="n">fit_intercept</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span> <span class="n">max_take</span> <span class="o">=</span> <span class="mi">20</span><span class="p">),</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(),</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="n">InvariantsPurifier</span><span class="p">(</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">Lars</span><span class="p">(</span><span class="n">n_nonzero_coefs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span> <span class="n">max_take</span> <span class="o">=</span> <span class="mi">20</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">),</span>
                                <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                             <span class="n">CovariantsPurifierBoth</span><span class="p">(</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">Lasso</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">17.0</span><span class="p">,</span> <span class="n">fit_intercept</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span> <span class="n">max_take</span> <span class="o">=</span> <span class="mi">20</span><span class="p">),</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(),</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="n">InvariantsPurifier</span><span class="p">(</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">LassoLars</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">),</span> <span class="n">max_take</span> <span class="o">=</span> <span class="mi">20</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">),</span>
                               <span class="n">StandardBlock</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<p>I. e. this way to define a model is very flexible and at the same time compact. Note also that some linear regressors constructs sparse model, i. e. Lasso. If these estimators use in their internal transform method this sparsity to speed up the prediction(I have not investigated it yet) it would immediatelly result that the nice transformer would also benefit from it. It also should be noted that Invariant purifiers always use covariants[:, :, 0, 0] as invariants even if invariants branch of
corresponding standard block is presented. It is done to not to fuck up with max_take parameter - covariants are always guaranteed to be pca-ed, and thus are always sorted in the order of decaying importance, while invariants can be not.</p>
<p>Let’s fit it:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">transformer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 750, while number of vectors is 500, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 500. Number of pca components is 75.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 750, while number of vectors is 500, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 500. Number of pca components is 75.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:201: UserWarning: Amount of provided data is less than the desired one to fit PCA. Number of components is 200, desired number of environments is 2000, actual number of environments is 500.
  self.n_components, num_fit_now, X.shape[0]))
/home/pozdn/nice/nice/transformers/purifiers.py:149: UserWarning: Amount of provided data is less than the desired one to fit InvariantsPurifer. Number of old features is 65, desired number of data points is 650, actual number of data points (n_env * (l + 1)) is 500, since number of environments is 500, and l is 0.
  new_block.shape[0], l))
/home/pozdn/nice/nice/transformers/purifiers.py:55: UserWarning: Amount of provided data is less than the desired one to fit InvariantsPurifer. Number of old features is 65, desired number of environments is 650, actual number of environments is 500.
  total_num, num_fit_now, new_block.shape[0]))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
9.812015295028687
</pre></div></div>
</div>
<p>Now we can transform the data:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">last_even</span><span class="p">,</span> <span class="n">last_odd</span><span class="p">,</span> <span class="n">invariants_even</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>It always return even-odd pair of covariants after the last block and all even invariants. In our case covariants are absent because last block doesn’t calcualte them</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">last_even</span><span class="p">,</span> <span class="n">last_odd</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
None None
</pre></div></div>
</div>
<p>Invariants is the dictionary with the keys corresponding to body order:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">invariants_even</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([1, 2, 3, 4, 5, 6])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="n">invariants_even</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape of invariants for nu = </span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">invariants_even</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
shape of invariants for nu = 1 : (100, 10)
shape of invariants for nu = 2 : (100, 600)
shape of invariants for nu = 3 : (100, 200)
shape of invariants for nu = 4 : (100, 501)
shape of invariants for nu = 5 : (100, 513)
shape of invariants for nu = 6 : (100, 2980)
</pre></div></div>
</div>
<p>We can put return_only_invariants = True to the transform method to get only invariants:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">invariants</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">],</span> <span class="n">return_only_invariants</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">invariants</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;dict&#39;&gt;
</pre></div></div>
</div>
<p>Parallelization is done internally. For the best performance it is necessary to call transform method with big chunks of data:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">structures</span> <span class="o">=</span> <span class="n">ase_io</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;../nice_with_calculations/structures.xyz&#39;</span><span class="p">,</span>
                         <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;0:10000&#39;</span><span class="p">)</span>

<span class="n">process_structures</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1">#process_structures(structures_val)</span>
<span class="n">HYPERS</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;interaction_cutoff&#39;</span><span class="p">:</span> <span class="mf">6.3</span><span class="p">,</span>
<span class="s1">&#39;max_radial&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;max_angular&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Constant&#39;</span><span class="p">,</span>
<span class="s1">&#39;gaussian_sigma_constant&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<span class="s1">&#39;cutoff_smooth_width&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
<span class="s1">&#39;radial_basis&#39;</span><span class="p">:</span> <span class="s1">&#39;GTO&#39;</span>
<span class="p">}</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">get_rascal_coefficients_parallelized</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="n">HYPERS</span><span class="p">)</span>
<span class="n">normalize_coefficients</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 100/100 [00:00&lt;00:00, 242.41it/s]
100%|██████████| 2/2 [00:00&lt;00:00, 24.13it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(40000, 10, 6, 11)
(10000, 10, 6, 11)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
<span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">:</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">num</span><span class="p">],</span> <span class="n">return_only_invariants</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">time_now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n environments: </span><span class="si">{}</span><span class="s2">, total time: </span><span class="si">{}</span><span class="s2">, time per environment: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">time_now</span><span class="p">,</span> <span class="n">time_now</span> <span class="o">/</span> <span class="n">num</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
n environments: 1, total time: 0.021193504333496094, time per environment: 0.021193504333496094
n environments: 2, total time: 0.016237974166870117, time per environment: 0.008118987083435059
n environments: 5, total time: 0.018302440643310547, time per environment: 0.0036604881286621095
n environments: 10, total time: 0.025880098342895508, time per environment: 0.0025880098342895507
n environments: 20, total time: 0.02851271629333496, time per environment: 0.001425635814666748
n environments: 50, total time: 0.04262256622314453, time per environment: 0.0008524513244628906
n environments: 100, total time: 0.08232641220092773, time per environment: 0.0008232641220092773
n environments: 200, total time: 0.16405344009399414, time per environment: 0.0008202672004699707
n environments: 500, total time: 0.41228604316711426, time per environment: 0.0008245720863342285
n environments: 1000, total time: 0.7639565467834473, time per environment: 0.0007639565467834473
n environments: 2000, total time: 1.5351052284240723, time per environment: 0.0007675526142120362
n environments: 5000, total time: 3.9592530727386475, time per environment: 0.0007918506145477295
n environments: 10000, total time: 8.130789756774902, time per environment: 0.0008130789756774903
</pre></div></div>
</div>
<p>We can access importances_ in the pca the same way as before: (I renamed transformer to c_trans because I copied this part of code from the other notebook with c_trans)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">c_trans</span> <span class="o">=</span> <span class="n">transformer</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nu: &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">initial_pca_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">initial_pca_</span><span class="o">.</span><span class="n">even_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">proper_log_plot</span><span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">initial_pca_</span><span class="o">.</span><span class="n">even_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">importances_</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;lambda = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">initial_pca_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">initial_pca_</span><span class="o">.</span><span class="n">odd_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">proper_log_plot</span><span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">initial_pca_</span><span class="o">.</span><span class="n">odd_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">importances_</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;lambda = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">blocks_</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nu: &quot;</span><span class="p">,</span> <span class="n">nu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_pca_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_pca_</span><span class="o">.</span><span class="n">even_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">proper_log_plot</span><span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_pca_</span><span class="o">.</span><span class="n">even_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">importances_</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;lambda = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_pca_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_pca_</span><span class="o">.</span><span class="n">odd_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">proper_log_plot</span><span class="p">(</span><span class="n">c_trans</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="n">nu</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_pca_</span><span class="o">.</span><span class="n">odd_pca_</span><span class="o">.</span><span class="n">pcas_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">importances_</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
nu:  1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_121_1.png" src="../_images/symlinks_user_guide_121_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
nu:  2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_121_3.png" src="../_images/symlinks_user_guide_121_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
nu:  3
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_121_5.png" src="../_images/symlinks_user_guide_121_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
nu:  4
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_121_7.png" src="../_images/symlinks_user_guide_121_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
nu:  5
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_121_9.png" src="../_images/symlinks_user_guide_121_9.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
No handles with labels found to put in legend.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
nu:  6
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_121_12.png" src="../_images/symlinks_user_guide_121_12.png" />
</div>
</div>
<p>Lines may be weird because of random parameters. And the last plot is absent because last block doesn’t calculate covariants.</p>
<p>As we noticed before actual number of components is different for different lambda. And we might be interested in it at every step of transformations. We can achieve it by calling get_intermediate_shape() method:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">intermediate_shapes</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">get_intermediate_shapes</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">intermediate_shapes</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;dict&#39;&gt;
</pre></div></div>
</div>
<p>It is nested dictionary:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">intermediate_shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span>  <span class="n">intermediate_shapes</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
after initial transformer : [[10, 0, 10, 0, 10, 0], [0, 10, 0, 10, 0, 10]]


after initial pca : [[10, 0, 10, 0, 10, 0], [0, 10, 0, 10, 0, 10]]


block nu = 1 -&gt; nu = 2 : {&#39;after covariants expansioner&#39;: [[65, 59, 149, 116, 162, 107], [0, 114, 94, 164, 118, 138]], &#39;after covariants pca&#39;: [[50, 50, 50, 50, 50, 50], [0, 50, 50, 50, 50, 50]], &#39;after invariants expansioner&#39;: 600}


block nu = 2 -&gt; nu = 3 : {&#39;after covariants expansioner&#39;: [[27, 36, 64, 62, 69, 54], [4, 50, 55, 71, 64, 61]], &#39;after covariants purifier&#39;: [[27, 36, 64, 62, 69, 54], [4, 50, 55, 71, 64, 61]], &#39;after covariants pca&#39;: [[27, 36, 64, 62, 69, 54], [4, 50, 55, 71, 64, 61]], &#39;after invariants expansioner&#39;: 501, &#39;after invariants pca&#39;: 200}


block nu = 3 -&gt; nu = 4 : {&#39;after covariants expansioner&#39;: [[15, 49, 64, 73, 73, 69], [19, 32, 50, 52, 58, 46]], &#39;after covariants purifier&#39;: [[15, 49, 64, 73, 73, 69], [19, 32, 50, 52, 58, 46]], &#39;after covariants pca&#39;: [[15, 49, 64, 73, 73, 69], [19, 32, 50, 52, 58, 46]], &#39;after invariants expansioner&#39;: 501, &#39;after invariants purifier&#39;: 501}


block nu = 4 -&gt; nu = 5 : {&#39;after covariants expansioner&#39;: [[18, 39, 59, 64, 66, 54], [16, 40, 53, 61, 62, 54]], &#39;after covariants purifier&#39;: [[18, 39, 59, 64, 66, 54], [16, 40, 53, 61, 62, 54]], &#39;after covariants pca&#39;: [[18, 39, 59, 64, 66, 54], [16, 40, 53, 61, 62, 54]], &#39;after invariants expansioner&#39;: 513, &#39;after invariants purifier&#39;: 513}


block nu = 5 -&gt; nu = 6 : {&#39;after invariants expansioner&#39;: 2980}


</pre></div></div>
</div>
<p>For next feature let’s take some not so crazy parameters:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">transformer</span> <span class="o">=</span> <span class="n">StandardSequence</span><span class="p">([</span><span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">),</span>
                                <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
                                             <span class="n">CovariantsPurifierBoth</span><span class="p">(</span><span class="n">max_take</span> <span class="o">=</span> <span class="mi">20</span><span class="p">),</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">),</span>
                                <span class="n">StandardBlock</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">),</span>
                                <span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">transformer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(10000, 10, 6, 11)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 2000, while number of vectors is 1000, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 1000. Number of pca components is 200.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 2000, while number of vectors is 1000, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 1000. Number of pca components is 200.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 2000, while number of vectors is 1000, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 1000. Number of pca components is 200.
  RuntimeWarning,
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
7.106444358825684
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">invariants_even</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">return_only_invariants</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>One another feature - at the last step we have block which calculates a lot of invariants without pca and purifier. We can access its “raw importances” which are given by the multiplication of source covariants importances in the ThresholdExpansioner.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">raw_importances</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">invariants_expansioner_</span><span class="o">.</span><span class="n">new_even_raw_importances_</span>
<span class="nb">print</span><span class="p">(</span><span class="n">raw_importances</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">invariants_even</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(504,)
(1000, 504)
</pre></div></div>
</div>
<p>Let’s do the following plot - on the x axis sqrt of raw importances (since they are multiplication of importances, i. e. multiplication of previous variances), and on the y axis real variance:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(((</span><span class="n">invariants_even</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">invariants_even</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">variances</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(504,)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">raw_importances</span><span class="p">),</span> <span class="n">variances</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x2abf0b566438&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_134_1.png" src="../_images/symlinks_user_guide_134_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">raw_importances</span><span class="p">),</span> <span class="n">variances</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/symlinks_user_guide_135_0.png" src="../_images/symlinks_user_guide_135_0.png" />
</div>
</div>
<p>There is some correlation, thresholding works somehow. Raw importances can be used for example to do the countoplot of rmse depending on 1) number of invariants to calculate and 2) number of invariants to keep with pca in single run of StandardSequence - just calculate the maximum amount of invarinats in the last block, and after that choose invariants to be pca-ed in the order of decreasing raw importances.</p>
<p>StandardSequence checks if some intermediate block doesn’t return covariants with importances_ (i. e. covariants pca is necessary) and raises error in this case.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">Lars</span><span class="p">,</span> <span class="n">LassoLars</span>

<span class="n">transformer</span> <span class="o">=</span> <span class="n">StandardSequence</span><span class="p">([</span><span class="n">StandardBlock</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">),</span>
                                <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                             <span class="n">CovariantsPurifierBoth</span><span class="p">(</span><span class="n">max_take</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">75</span><span class="p">),</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">InvariantsPCA</span><span class="p">(</span><span class="mi">200</span><span class="p">)),</span>
                                <span class="p">])</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-68-6ca1f7beea64&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>                                              ThresholdExpansioner<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">500</span><span class="ansi-blue-fg">,</span> mode <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&#39;invariants&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     13</span>                                              <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">---&gt; 14</span><span class="ansi-red-fg">                                              InvariantsPCA(200)),
</span><span class="ansi-green-intense-fg ansi-bold">     15</span>                                 ])

<span class="ansi-green-fg">~/nice/nice/transformers/grouping.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, blocks, initial_pca, initial_scaler, guaranteed_parts_fitted_consistently)</span>
<span class="ansi-green-intense-fg ansi-bold">    236</span>             <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>blocks_<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>higher_body_orders_possible_<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    237</span>                 raise ValueError(
<span class="ansi-green-fg">--&gt; 238</span><span class="ansi-red-fg">                     </span><span class="ansi-blue-fg">&#34;all intermediate standard blocks should calculate covariants&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    239</span>                 )
<span class="ansi-green-intense-fg ansi-bold">    240</span>         self<span class="ansi-blue-fg">.</span>initial_transformer_ <span class="ansi-blue-fg">=</span> InitialTransformer<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">ValueError</span>: all intermediate standard blocks should calculate covariants
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">Lars</span><span class="p">,</span> <span class="n">LassoLars</span>

<span class="n">transformer</span> <span class="o">=</span> <span class="n">StandardSequence</span><span class="p">([</span><span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">),</span>
                                <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                             <span class="n">CovariantsPurifierBoth</span><span class="p">(</span><span class="n">max_take</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">75</span><span class="p">),</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">InvariantsPCA</span><span class="p">(</span><span class="mi">200</span><span class="p">)),</span>
                                <span class="p">])</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-69-8b6d6a6d6f57&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>                                              ThresholdExpansioner<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">500</span><span class="ansi-blue-fg">,</span> mode <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&#39;invariants&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     13</span>                                              <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">---&gt; 14</span><span class="ansi-red-fg">                                              InvariantsPCA(200)),
</span><span class="ansi-green-intense-fg ansi-bold">     15</span>                                 ])

<span class="ansi-green-fg">~/nice/nice/transformers/grouping.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, blocks, initial_pca, initial_scaler, guaranteed_parts_fitted_consistently)</span>
<span class="ansi-green-intense-fg ansi-bold">    236</span>             <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>blocks_<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>higher_body_orders_possible_<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    237</span>                 raise ValueError(
<span class="ansi-green-fg">--&gt; 238</span><span class="ansi-red-fg">                     </span><span class="ansi-blue-fg">&#34;all intermediate standard blocks should calculate covariants&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    239</span>                 )
<span class="ansi-green-intense-fg ansi-bold">    240</span>         self<span class="ansi-blue-fg">.</span>initial_transformer_ <span class="ansi-blue-fg">=</span> InitialTransformer<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">ValueError</span>: all intermediate standard blocks should calculate covariants
</pre></div></div>
</div>
</div>
<div class="section" id="Custom-regressors-into-purifiers">
<h1>Custom regressors into purifiers<a class="headerlink" href="#Custom-regressors-into-purifiers" title="Permalink to this headline">¶</a></h1>
<p>Let’s say we need some regressor which is not listed in sklearn.linear_model. Not a problem we can implement it ourselves. Let’s say we need purifier based on Ridge, which would determine best alpha by the cross validation on the training set:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_predict</span>

<span class="k">class</span> <span class="nc">AdaptiveRidge</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">minimum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_alpha_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">300</span><span class="p">):</span>
            <span class="n">clf</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fit_intercept</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">predictions</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">minimum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">minimum</span><span class="p">):</span>
                <span class="n">minimum</span> <span class="o">=</span> <span class="n">now</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_alpha_</span> <span class="o">=</span> <span class="n">alpha</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ridge_</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_alpha_</span><span class="p">,</span> <span class="n">fit_intercept</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ridge_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ridge_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
<p>It has two additonal methods get_params and set_params. It is because my implementation is based on sklearn.base.clone function (<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.base.clone.html">https://scikit-learn.org/stable/modules/generated/sklearn.base.clone.html</a>). And thus all classes should obey some requirements to make it work. See section cloning here <a class="reference external" href="https://scikit-learn.org/stable/developers/develop.html">https://scikit-learn.org/stable/developers/develop.html</a>.</p>
<p>Let’s run it:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">LinAlgWarning</span>
<span class="n">transformer</span> <span class="o">=</span> <span class="n">StandardSequence</span><span class="p">([</span><span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="kc">None</span><span class="p">),</span>
                                <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                                             <span class="n">CovariantsPurifierBoth</span><span class="p">(</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">AdaptiveRidge</span><span class="p">(),</span> <span class="n">max_take</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span>
                                             <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">75</span><span class="p">),</span>
                                             <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">),</span>
                                             <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">InvariantsPCA</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
                                <span class="p">])</span>
<span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span> <span class="n">LinAlgWarning</span><span class="p">)</span>   <span class="c1">#a lot of ill conditioned matrices with super small alpha</span>
    <span class="n">transformer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span>
<span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 150, while number of vectors is 100, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 100. Number of pca components is 15.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/purifiers.py:149: UserWarning: Amount of provided data is less than the desired one to fit InvariantsPurifer. Number of old features is 20, desired number of data points is 200, actual number of data points (n_env * (l + 1)) is 100, since number of environments is 100, and l is 0.
  new_block.shape[0], l))
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 750, while number of vectors is 100, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 100. Number of pca components is 75.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 375, while number of vectors is 100, dimensionality of single vector (lambd + 1) is 2, i. e. total number of points is 200. Number of pca components is 75.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 750, while number of vectors is 100, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 100. Number of pca components is 75.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 375, while number of vectors is 100, dimensionality of single vector (lambd + 1) is 2, i. e. total number of points is 200. Number of pca components is 75.
  RuntimeWarning,
/home/pozdn/nice/nice/transformers/compressors.py:201: UserWarning: Amount of provided data is less than the desired one to fit PCA. Number of components is 50, desired number of environments is 500, actual number of environments is 100.
  self.n_components, num_fit_now, X.shape[0]))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
19.038315773010254
0.06949567794799805
</pre></div></div>
</div>
<p>Fitting takes a lot of time, but prediction is still okay. Let’s look at the resulting best alpha:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">transformer</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_purifier_</span><span class="o">.</span><span class="n">even_purifier_</span><span class="o">.</span><span class="n">purifiers_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;even &quot;</span><span class="p">,</span> <span class="n">lambd</span><span class="p">,</span> <span class="n">transformer</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_purifier_</span><span class="o">.</span><span class="n">even_purifier_</span><span class="o">.</span><span class="n">purifiers_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]</span><span class="o">.</span><span class="n">regressor_</span><span class="o">.</span><span class="n">best_alpha_</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">transformer</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_purifier_</span><span class="o">.</span><span class="n">odd_purifier_</span><span class="o">.</span><span class="n">purifiers_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;odd &quot;</span><span class="p">,</span> <span class="n">lambd</span><span class="p">,</span> <span class="n">transformer</span><span class="o">.</span><span class="n">blocks_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">covariants_purifier_</span><span class="o">.</span><span class="n">odd_purifier_</span><span class="o">.</span><span class="n">purifiers_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]</span><span class="o">.</span><span class="n">regressor_</span><span class="o">.</span><span class="n">best_alpha_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
even  0 0.015040335536380345
even  1 0.0004523956232538058
odd  1 0.17012542798525995
even  2 0.011486842567375548
odd  2 0.019693113379074298
even  3 0.04420637972028548
odd  3 0.00511717300711461
even  4 0.002279604637318982
odd  4 0.025785243528842764
even  5 0.025785243528842764
odd  5 2.3874067718606566e-07
</pre></div></div>
</div>
<p>It is inconvenient to access them, but it is not designed to, and it is not expected that users would do it often. For properties such as explained_variance_ in the pca I am planing to add getters</p>
</div>
<div class="section" id="Sequential-fitting">
<h1>Sequential fitting<a class="headerlink" href="#Sequential-fitting" title="Permalink to this headline">¶</a></h1>
<p>It may be usefull to fit blocks sequentially, deciding which hypers to take for the next block based on the results of previous block. After that we would like to pack blocks into the StandardSequence to have convenient transform method. Let’s do it:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">even_0</span><span class="p">,</span> <span class="n">odd_0</span> <span class="o">=</span> <span class="n">InitialTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">initial_pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">()</span>
<span class="n">initial_pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">even_0</span><span class="p">,</span> <span class="n">odd_0</span><span class="p">)</span>
<span class="n">even_0_t</span><span class="p">,</span> <span class="n">odd_0_t</span> <span class="o">=</span> <span class="n">initial_pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">even_0</span><span class="p">,</span> <span class="n">odd_0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">block_1</span> <span class="o">=</span> <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">block_1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">even_0_t</span><span class="p">,</span> <span class="n">odd_0_t</span><span class="p">,</span> <span class="n">even_0_t</span><span class="p">,</span> <span class="n">odd_0_t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 200, while number of vectors is 100, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 100. Number of pca components is 20.
  RuntimeWarning,
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">even_1</span><span class="p">,</span> <span class="n">odd_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">block_1</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">even_0_t</span><span class="p">,</span> <span class="n">odd_0_t</span><span class="p">,</span> <span class="n">even_0_t</span><span class="p">,</span> <span class="n">odd_0_t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">block_2</span> <span class="o">=</span> <span class="n">StandardBlock</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">block_2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">even_1</span><span class="p">,</span> <span class="n">odd_1</span><span class="p">,</span> <span class="n">even_0_t</span><span class="p">,</span> <span class="n">odd_0_t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">even_invariants</span> <span class="o">=</span> <span class="n">block_2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">even_1</span><span class="p">,</span> <span class="n">odd_1</span><span class="p">,</span> <span class="n">even_0_t</span><span class="p">,</span> <span class="n">odd_0_t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>So, we have fitted all the parts, now let’s construct StandardSequence:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trans</span> <span class="o">=</span> <span class="n">StandardSequence</span><span class="p">(</span><span class="n">initial_pca</span><span class="o">=</span> <span class="n">initial_pca</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_1</span><span class="p">,</span> <span class="n">block_2</span><span class="p">])</span>
<span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">even_invariants_new</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NotFittedError</span>                            Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-81-d6225ef2aee8&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> trans <span class="ansi-blue-fg">=</span> StandardSequence<span class="ansi-blue-fg">(</span>initial_pca<span class="ansi-blue-fg">=</span> initial_pca<span class="ansi-blue-fg">,</span> blocks <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>block_1<span class="ansi-blue-fg">,</span> block_2<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span>_<span class="ansi-blue-fg">,</span> _<span class="ansi-blue-fg">,</span> even_invariants_new <span class="ansi-blue-fg">=</span> trans<span class="ansi-blue-fg">.</span>transform<span class="ansi-blue-fg">(</span>coefficients<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">6</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span><span class="ansi-cyan-fg">100</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/nice/nice/transformers/grouping.py</span> in <span class="ansi-cyan-fg">transform</span><span class="ansi-blue-fg">(self, coefficients, return_only_invariants)</span>
<span class="ansi-green-intense-fg ansi-bold">    318</span>             raise NotFittedError(
<span class="ansi-green-intense-fg ansi-bold">    319</span>                 <span class="ansi-blue-fg">&#34;instance of {} is not fitted. It can not transform anything&#34;</span><span class="ansi-blue-fg">.</span>
<span class="ansi-green-fg">--&gt; 320</span><span class="ansi-red-fg">                 format(type(self).__name__))
</span><span class="ansi-green-intense-fg ansi-bold">    321</span>
<span class="ansi-green-intense-fg ansi-bold">    322</span>         <span class="ansi-green-fg">if</span> <span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>initial_scaler_ <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">NotFittedError</span>: instance of StandardSequence is not fitted. It can not transform anything
</pre></div></div>
</div>
<p>Oops, it tells that it is not fitted. The issue is that we need to specify one additional parameter in the init -guaranteed_parts_fitted_consistently. It is done for the purpose to make user do such constructions responsibly, because at this point there are a lot of potential bugs, where we would construct StandardSequence from fitted parts, but from fitted inconsistently - i. e. Purifier fitted to purify nu = 10 covariants, and pca to compress nu = 7 covariants.</p>
<p>StandardSequence is considered to be fitted if all parts are fitted and if guaranteed_parts_fitted_consistently set to be True</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trans</span> <span class="o">=</span> <span class="n">StandardSequence</span><span class="p">(</span><span class="n">initial_pca</span><span class="o">=</span> <span class="n">initial_pca</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_1</span><span class="p">,</span> <span class="n">block_2</span><span class="p">],</span>
                         <span class="n">guaranteed_parts_fitted_consistently</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">even_invariants_new</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">even_invariants_new</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([1, 2, 3])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">even_invariants</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">even_invariants_new</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[ 2.01247343 -0.1257774  -0.16815822 -0.23461774 -0.0047428 ]
[ 2.01247343 -0.1257774  -0.16815822 -0.23461774 -0.0047428 ]
</pre></div></div>
</div>
<p>The same is related to StandardBlock. It is considered as fitted if 1) all parts are fitted and 2) if guaranteed_parts_fitted_consistently set to be True</p>
<p>It can also work in the other direction:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">initial_pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">()</span>
<span class="n">block_1</span> <span class="o">=</span> <span class="n">StandardBlock</span><span class="p">(</span><span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="n">block_2</span> <span class="o">=</span> <span class="n">StandardBlock</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;invariants&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">initial_pca</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">block_1</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">block_2</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
False
False
False
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trans</span> <span class="o">=</span> <span class="n">StandardSequence</span><span class="p">(</span><span class="n">initial_pca</span> <span class="o">=</span> <span class="n">initial_pca</span><span class="p">,</span> <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_1</span><span class="p">,</span> <span class="n">block_2</span><span class="p">])</span>
<span class="n">trans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/pozdn/nice/nice/transformers/compressors.py:107: RuntimeWarning: given data is less than desired number of points to fit pca. Desired number of points to fit pca is 200, while number of vectors is 100, dimensionality of single vector (lambd + 1) is 1, i. e. total number of points is 100. Number of pca components is 20.
  RuntimeWarning,
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">initial_pca</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">block_1</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">block_2</span><span class="o">.</span><span class="n">is_fitted</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
True
True
</pre></div></div>
</div>
<p>But the other direction will not work in case of linear regressor passed to CovariantsPurifier and CovariantsPurifierBoth. Indeed, these classes need several different instances of linear regressor for different lambda chaneels. So they are based on sklearn.base.clone (<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.base.clone.html">https://scikit-learn.org/stable/modules/generated/sklearn.base.clone.html</a>), and do not touch initial instance in any way.</p>
</div>
<div class="section" id="Non-standard-sequence">
<h1>Non standard sequence<a class="headerlink" href="#Non-standard-sequence" title="Permalink to this headline">¶</a></h1>
<p>If we would like to go beyond standard nice sequence, we can always use expansioners, purifiers and compressors by our own. Let’s go to nu = 1024 for example:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">tqdm</span>
<span class="n">data_even_1</span><span class="p">,</span> <span class="n">data_odd_1</span>  <span class="o">=</span> <span class="n">InitialTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">])</span>
<span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span> <span class="o">=</span> <span class="n">data_even_1</span><span class="p">,</span> <span class="n">data_odd_1</span>

<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span> <span class="c1"># a lot of pca doesn&#39;t have enough data to fit</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)):</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">IndividualLambdaPCAsBoth</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span><span class="p">)</span>
        <span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span>  <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span><span class="p">)</span>
        <span class="n">expansioner</span> <span class="o">=</span> <span class="n">ThresholdExpansioner</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">expansioner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span><span class="p">,</span> <span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span><span class="p">,</span> <span class="n">clebsch_gordan</span> <span class="o">=</span> <span class="n">clebsch</span><span class="p">)</span>
        <span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span> <span class="o">=</span> <span class="n">expansioner</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span><span class="p">,</span> <span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span><span class="p">)</span>

        <span class="c1"># because of very high body order we observe numerical instabilities,</span>
        <span class="c1">#and thus we need kind of normalize data on the fly:</span>
        <span class="k">for</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">data_even_now</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">even_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_even_now</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="p">:</span><span class="n">data_even_now</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">even_factor</span> <span class="o">&gt;</span> <span class="mf">1e-15</span><span class="p">):</span> <span class="c1">#catch exact zeros</span>
                    <span class="n">data_even_now</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="p">:</span><span class="n">data_even_now</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">]</span> <span class="o">/=</span> <span class="n">even_factor</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">data_odd_now</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">odd_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_odd_now</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="p">:</span><span class="n">data_odd_now</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">odd_factor</span> <span class="o">&gt;</span> <span class="mf">1e-15</span><span class="p">):</span> <span class="c1">#catch exact zeros</span>
                    <span class="n">data_odd_now</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="p">:</span><span class="n">data_odd_now</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">]</span> <span class="o">/=</span> <span class="n">odd_factor</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 10/10 [00:10&lt;00:00,  1.07s/it]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[90]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">data_even_now</span><span class="o">.</span><span class="n">covariants_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even_now</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_odd_now</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1000, 395, 6, 11)
[ 70 210 324 385 395 356]
[ 82 222 332 386 396 368]
</pre></div></div>
</div>
</div>
<div class="section" id="Meet-definition-from-the-article">
<h1>Meet definition from the article<a class="headerlink" href="#Meet-definition-from-the-article" title="Permalink to this headline">¶</a></h1>
<p>Data even and data odd are defined in a such way that data even entirely remains constant under inversion, while data odd entirely changes the sign under inversion. In the article covariants with sigma = +1 are defined such a way that they transforms under inversion as (-1)^lambd, i. e. as true tensors, and covariants with sigma = -1 are defined such a way that they transforms as (-1)^(lambd + 1), i. e. as pseudo tensors. There is special class to change parity defintion:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_true</span><span class="p">,</span> <span class="n">data_pseudo</span> <span class="o">=</span> <span class="n">ParityDefinitionChanger</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_even_now</span><span class="p">,</span> <span class="n">data_odd_now</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">data_true</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_pseudo</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[ 70 222 324 386 395 368]
[ 82 210 332 385 396 356]
</pre></div></div>
</div>
<p>This transformation is symmetric, i. e. we can apply it once again to get odd and even datas from the true and pseudo:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_even</span><span class="p">,</span> <span class="n">data_odd</span> <span class="o">=</span> <span class="n">ParityDefinitionChanger</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_true</span><span class="p">,</span> <span class="n">data_pseudo</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[ 70 210 324 385 395 356]
[ 82 222 332 386 396 368]
</pre></div></div>
</div>
<p>Let’s check consistency:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_even</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">data_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">,</span> <span class="p">:(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">-</span> \
                        <span class="n">data_even_now</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">data_even</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">,</span> <span class="p">:(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])))</span>

<span class="k">for</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_odd</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">data_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">,</span> <span class="p">:(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">-</span> \
                        <span class="n">data_odd_now</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">data_odd</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">,</span> <span class="p">:(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.0
0.0
0.0
0.0
0.0
0.0
0.0
0.0
0.0
0.0
0.0
0.0
</pre></div></div>
</div>
<p>And there is one another difference - in the article covariants are in the sqrt(2 * lambd + 1) less than the ones that we obtained.</p>
<p>(in the code iterations in formula (4) are done without coefficient c_{k, lambd}. If one would unroll definition of this coefficient it would become clear that iteration in the formula (4) consist of 1) multiplying covariants by sqrt(2 * lambd + 1) 2) of iteration without this coefficient and 3) of division of the result by sqrt(2 * lambd + 1). I decided not to do this, because 1) it is additional unnecessary computational costs 2) this coefficient is not symmetric with respect to the inputs
to the clebsch gordan iterations, and thus if I would apply this, expansioner would be able to do coupling of only v body order features and 1 body order features, not arbitrary v1 and v2. ).</p>
<p>This exactly (up to machine arithmetic accuracy) doesn’t change the results until importances which are used in the ThresholdExpansioner remains constant under the uniform scaling. In current implementation they are, since they are <strong>normalized</strong> variances.</p>
<p>So, the last step is to do division:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">lambd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">data_true</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="p">:</span><span class="n">data_true</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">,</span> <span class="p">:(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">data_pseudo</span><span class="o">.</span><span class="n">covariants_</span><span class="p">[:,</span> <span class="p">:</span><span class="n">data_pseudo</span><span class="o">.</span><span class="n">actual_sizes_</span><span class="p">[</span><span class="n">lambd</span><span class="p">],</span> <span class="n">lambd</span><span class="p">,</span> <span class="p">:(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lambd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="methane_home_pc_tutorial.html" class="btn btn-neutral float-left" title="Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Jigyasa Nigam, Sergey Pozdnyakov, Michele Ceriotti

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>